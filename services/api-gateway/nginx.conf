# Little Monster API Gateway - Nginx Configuration
# Routes ALL 13 microservices - COMPLETE SYSTEM

events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Upstream service definitions - ALL 13 SERVICES
    upstream auth_service {
        server lm-auth:8000;
    }

    upstream llm_service {
        server lm-llm:8000;
    }

    upstream stt_service {
        server lm-stt:8000;
    }

    upstream tts_service {
        server lm-tts:8000;
    }

    upstream recording_service {
        server lm-recording:8000;
    }

    upstream jobs_service {
        server lm-jobs:8000;
    }

    upstream notifications_service {
        server lm-notifications:8013;
    }

    upstream class_management_service {
        server lm-class-mgmt:8005;
    }

    upstream ai_study_tools_service {
        server lm-ai-study-tools:8009;
    }

    upstream content_capture_service {
        server lm-content-capture:8008;
    }

    upstream gamification_service {
        server lm-gamification:8011;
    }

    upstream study_analytics_service {
        server lm-analytics:8012;
    }

    upstream social_collaboration_service {
        server lm-social-collab:8010;
    }

    # Main server block
    server {
        listen 80;
        server_name localhost;

        # Hide CORS headers from backend services - nginx handles CORS centrally
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Max-Age;

        # CORS headers - Set by nginx only
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With, Accept, Origin' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' '3600' always;

        # DISABLE ALL CACHING FOR DEVELOPMENT
        add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0' always;
        add_header 'Pragma' 'no-cache' always;
        add_header 'Expires' '0' always;
        proxy_no_cache 1;
        proxy_cache_bypass 1;

        # Handle preflight OPTIONS requests
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Authentication
        location /api/auth/ {
            proxy_pass http://auth_service/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # LLM Chat
        location /api/chat/ {
            proxy_pass http://llm_service/chat/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # Speech-to-Text
        location /api/transcribe/ {
            proxy_pass http://stt_service/transcribe/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
        }

        # Text-to-Speech
        location /api/tts/ {
            proxy_pass http://tts_service/tts/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Audio Recording
        location /api/recordings/ {
            proxy_pass http://recording_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
        }

        # Jobs
        location /api/jobs/ {
            proxy_pass http://jobs_service/jobs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notifications
        location /api/notifications/ {
            proxy_pass http://notifications_service/api/notifications/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Messages
        location /api/messages/ {
            proxy_pass http://notifications_service/api/messages/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Classes
        location /api/classes {
            proxy_pass http://class_management_service/api/classes;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Assignments
        location /api/assignments {
            proxy_pass http://class_management_service/api/assignments;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # AI Notes
        location /api/notes/ {
            proxy_pass http://ai_study_tools_service/api/notes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Flashcards
        location /api/flashcards/ {
            proxy_pass http://ai_study_tools_service/api/flashcards/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Tests
        location /api/tests/ {
            proxy_pass http://ai_study_tools_service/api/tests/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Photos
        location /api/photos/ {
            proxy_pass http://content_capture_service/api/photos/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
        }

        # Textbooks
        location /api/textbooks/ {
            proxy_pass http://content_capture_service/api/textbooks/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
        }

        # Gamification - Points
        location /api/points/ {
            proxy_pass http://gamification_service/api/points/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Gamification - Achievements
        location /api/achievements/ {
            proxy_pass http://gamification_service/api/achievements/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Gamification - Leaderboards
        location /api/leaderboards/ {
            proxy_pass http://gamification_service/api/leaderboards/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Study Analytics - Sessions
        location /api/sessions/ {
            proxy_pass http://study_analytics_service/api/sessions/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Study Analytics - Goals
        location /api/goals/ {
            proxy_pass http://study_analytics_service/api/goals/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Social - Connections
        location /api/connections/ {
            proxy_pass http://social_collaboration_service/api/connections/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Social - Groups
        location /api/groups/ {
            proxy_pass http://social_collaboration_service/api/groups/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Social - Sharing
        location /api/sharing/ {
            proxy_pass http://social_collaboration_service/api/sharing/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check
        location /health {
            return 200 '{"status":"healthy","service":"api-gateway","services":13}';
            add_header Content-Type application/json;
        }

        # Default
        location / {
            return 404 '{"error":"Not found"}';
            add_header Content-Type application/json;
        }
    }
}
