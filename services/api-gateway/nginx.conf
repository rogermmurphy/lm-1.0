# Little Monster API Gateway - Nginx Configuration
# Routes all API requests to appropriate microservices

events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Upstream service definitions (using Docker service names)
    upstream auth_service {
        server lm-auth:8000;
    }

    upstream llm_service {
        server lm-llm:8000;
    }

    upstream stt_service {
        server lm-stt:8000;
    }

    upstream tts_service {
        server lm-tts:8000;
    }

    upstream recording_service {
        server lm-recording:8000;
    }

    upstream jobs_service {
        server lm-jobs:8000;
    }

    # Main server block
    server {
        listen 80;
        server_name localhost;

        # CORS headers for all responses
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

        # Handle OPTIONS requests
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Authentication Service
        location /api/auth/ {
            proxy_pass http://auth_service/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # LLM Agent Service (Chat)
        location /api/chat/ {
            proxy_pass http://llm_service/chat/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;  # LLM responses can be slow
        }

        # Speech-to-Text Service
        location /api/transcribe/ {
            proxy_pass http://stt_service/transcribe/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;  # Allow large audio files
        }

        # Text-to-Speech Service
        location /api/tts/ {
            proxy_pass http://tts_service/tts/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Audio Recording Service
        location /api/recordings/ {
            proxy_pass http://recording_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
        }

        # Async Jobs Service
        location /api/jobs/ {
            proxy_pass http://jobs_service/jobs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint (gateway itself)
        location /health {
            return 200 '{"status":"healthy","service":"api-gateway","version":"1.0.0"}';
            add_header Content-Type application/json;
        }

        # Default route
        location / {
            return 404 '{"error":"Not found","message":"Use /api/* endpoints"}';
            add_header Content-Type application/json;
        }
    }
}
