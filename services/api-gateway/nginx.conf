# Little Monster API Gateway - Nginx Configuration
# Routes all API requests to appropriate microservices

events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Upstream service definitions (using Docker service names)
    upstream auth_service {
        server lm-auth:8000;
    }

    upstream llm_service {
        server lm-llm:8000;
    }

    upstream stt_service {
        server lm-stt:8000;
    }

    upstream tts_service {
        server lm-tts:8000;
    }

    upstream recording_service {
        server lm-recording:8000;
    }

    upstream jobs_service {
        server lm-jobs:8000;
    }

    upstream class_mgmt_service {
        server lm-class-mgmt:8005;
    }

    upstream content_capture_service {
        server lm-content-capture:8008;
    }

    upstream ai_study_service {
        server lm-ai-study-tools:8009;
    }

    upstream social_service {
        server lm-social-collab:8010;
    }

    upstream gamification_service {
        server lm-gamification:8011;
    }

    upstream analytics_service {
        server lm-analytics:8012;
    }

    upstream notifications_service {
        server lm-notifications:8013;
    }

    # Main server block
    server {
        listen 80;
        server_name localhost;

        # CORS headers for all responses - Allow all origins for home network access
        # Supports: localhost, 127.0.0.1, 192.168.x.x, public IP
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With, Accept, Origin' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' '3600' always;

        # Handle OPTIONS requests
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Authentication Service
        location /api/auth/ {
            proxy_pass http://auth_service/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # LLM Agent Service (Chat)
        location /api/chat/ {
            proxy_pass http://llm_service/chat/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;  # LLM responses can be slow
        }

        # Speech-to-Text Service
        location /api/transcribe/ {
            proxy_pass http://stt_service/transcribe/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;  # Allow large audio files
        }

        # Text-to-Speech Service
        location /api/tts/ {
            proxy_pass http://tts_service/tts/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Audio Recording Service
        location /api/recordings/ {
            proxy_pass http://recording_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
        }

        # Async Jobs Service
        location /api/jobs/ {
            proxy_pass http://jobs_service/jobs/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Class Management Service
        location /api/classes/ {
            proxy_pass http://class_mgmt_service/classes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/assignments/ {
            proxy_pass http://class_mgmt_service/assignments/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Content Capture Service
        location /api/photos/ {
            proxy_pass http://content_capture_service/photos/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 100M;  # Allow large image files
        }

        location /api/textbooks/ {
            proxy_pass http://content_capture_service/textbooks/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 100M;  # Allow large PDF files
        }

        # AI Study Tools Service
        location /api/notes/ {
            proxy_pass http://ai_study_service/notes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;  # AI generation can be slow
        }

        location /api/flashcards/ {
            proxy_pass http://ai_study_service/flashcards/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        location /api/tests/ {
            proxy_pass http://ai_study_service/tests/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # Social Collaboration Service
        location /api/connections/ {
            proxy_pass http://social_service/connections/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/groups/ {
            proxy_pass http://social_service/groups/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/sharing/ {
            proxy_pass http://social_service/sharing/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Gamification Service
        location /api/points/ {
            proxy_pass http://gamification_service/points/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/achievements/ {
            proxy_pass http://gamification_service/achievements/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/leaderboards/ {
            proxy_pass http://gamification_service/leaderboards/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Study Analytics Service
        location /api/sessions/ {
            proxy_pass http://analytics_service/sessions/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/goals/ {
            proxy_pass http://analytics_service/goals/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notifications and Messages Service
        location /api/notifications/ {
            proxy_pass http://notifications_service/notifications/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/messages/ {
            proxy_pass http://notifications_service/messages/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint (gateway itself)
        location /health {
            return 200 '{"status":"healthy","service":"api-gateway","version":"1.0.0"}';
            add_header Content-Type application/json;
        }

        # Default route
        location / {
            return 404 '{"error":"Not found","message":"Use /api/* endpoints"}';
            add_header Content-Type application/json;
        }
    }
}
